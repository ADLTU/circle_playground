version: 2.1

orbs:
  python: circleci/python@1.5.0
  terraform: circleci/terraform@3.2.0
  gcp-cli: circleci/gcp-cli@3.1.0
  build-tools: circleci/build-tools@3.0.0

commands:
  authenticate:
    steps:
      - gcp-cli/setup:
          use_oidc: true
          google_project_id: GCP_PROJECT_ID
          google_project_number: GCP_PROJECT_NUMBER
          service_account_email: GCP_SERVICE_ACCOUNT_EMAIL
          workload_identity_pool_id: GCP_WIP_ID
          workload_identity_pool_provider_id: GCP_WIP_PROVIDER_ID
      - run:
          name: Check Active Account
          command: gcloud auth list

  rebuild-decoder-container:
    steps:
      - run:
          name: Check Active Account
          command: gcloud auth list

executor: gcp-cli/default

jobs:
  go-for-it:
    docker:
      - image: google/cloud-sdk:437.0.0
    resource_class: small
    steps:
      - checkout
      - authenticate  # Removed 'context: decoder'
      - rebuild-decoder-container

workflows:
  version: 2
  my-workflow:
    jobs:
      - go-for-it
